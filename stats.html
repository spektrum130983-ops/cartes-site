<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Statistiques de ma collection</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #ffe4e1;
    color: #333;
  }

  header {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8cdda, #1d2b64);
    color: white;
    border-bottom: 4px solid #f8cdda;
  }

  header h1 {
    margin: 0;
    font-size: 1.5em;
  }

  #statsGlobales {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin: 20px;
  }

  .stat-card {
    position: relative;
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-align: center;
    font-weight: bold;
    display: inline-block;
    min-width: 200px;
    cursor: default;
  }

  .stat-card span {
    display: block; /* retour √† la ligne */
    margin-top: 4px;
    font-size: 1.1em;
  }

  /* Tooltip */
  .stat-card[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.8em;
    white-space: nowrap;
    z-index: 1000;
  }

  #statsSeries {
    margin: 30px;
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  #statsSeries h2 {
    text-align: center;
    margin-bottom: 15px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }

  th {
    background: #ffb6c1;
  }
</style>
</head>
<body>

<header>
  <h1>üìä Statistiques de ma collection</h1>
</header>

<!-- Totaux globaux -->
<div id="statsGlobales">
  <div class="stat-card" id="statAchat" data-tooltip="Somme des prix d'achat renseign√©s (colonne M)">
    Valeur d'achat r√©elle
    <span>0 ‚Ç¨</span>
  </div>
  <div class="stat-card" id="statActuel" data-tooltip="Somme des prix actuels renseign√©s (colonne N)">
    Valeur actuelle r√©elle
    <span>0 ‚Ç¨</span>
  </div>
  <div class="stat-card" id="statGain" data-tooltip="Gain r√©el = valeur actuelle r√©elle - valeur d'achat r√©elle">
    Gain / Perte r√©elle
    <span>0 ‚Ç¨</span>
  </div>

  <!-- Totaux simul√©s -->
  <div class="stat-card" id="statAchatSim" data-tooltip="Somme des prix d'achat simul√©s : moyenne de la s√©rie si vide">
    Valeur d'achat simul√©e
    <span>0 ‚Ç¨</span>
  </div>
  <div class="stat-card" id="statActuelSim" data-tooltip="Somme des prix actuels simul√©s : prix d'achat simul√© si vide">
    Valeur actuelle simul√©e
    <span>0 ‚Ç¨</span>
  </div>
  <div class="stat-card" id="statGainSim" data-tooltip="Gain simul√© = valeur actuelle simul√©e - valeur d'achat simul√©e">
    Gain / Perte simul√©e
    <span>0 ‚Ç¨</span>
  </div>
</div>

<!-- Stats par s√©rie -->
<div id="statsSeries">
  <h2>üìå D√©tails par s√©rie</h2>
  <table id="seriesTable">
    <thead>
      <tr>
        <th>S√©rie</th>
        <th>Achat r√©el (‚Ç¨)</th>
        <th>Actuel r√©el (‚Ç¨)</th>
        <th>Achat simul√© (‚Ç¨)</th>
        <th>Actuel simul√© (‚Ç¨)</th>
        <th>Gain/Perte r√©el (‚Ç¨)</th>
        <th>Gain/Perte simul√© (‚Ç¨)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1Qu3UDfkrM2r4XgsyWBxZBlgQtaTw8TOy7CHlI--kSbU/gviz/tq?tqx=out:json&gid=658465532";
let allCards = [];

fetch(sheetURL)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substr(47).slice(0, -2));
    allCards = json.table.rows.map(row => ({
      serie: row.c[0]?.v || "",
      nomSet: row.c[1]?.v || "",
      booster: row.c[2]?.v || "",
      annee: row.c[3]?.f ? new Date(row.c[3].f).getFullYear().toString() : (row.c[3]?.v ? row.c[3].v.toString() : ""),
      date: row.c[4]?.f || "",
      langue: row.c[5]?.v || "",
      type: row.c[6]?.v || "",
      nombre: row.c[7]?.f || "",
      code: row.c[8]?.v || "",
      image: row.c[9]?.v || "",
      pdf: row.c[10]?.v || "",
      imageOriginal: row.c[11]?.v || "",
      prixAchat: row.c[12]?.v ? parseFloat(row.c[12].v) : null,   // colonne M
      prixActuel: row.c[13]?.v ? parseFloat(row.c[13].v) : null   // colonne N
    }));

    calculerStats();
  })
  .catch(err => console.error("Erreur chargement:", err));

function calculerStats() {
  let totalAchat = 0, totalActuel = 0;
  let totalAchatSim = 0, totalActuelSim = 0;

  // Calcul des moyennes par s√©rie pour estimer les prix manquants
  const seriesMoyennes = {};
  const groupBySerie = {};
  allCards.forEach(c => {
    if (!groupBySerie[c.serie]) groupBySerie[c.serie] = [];
    groupBySerie[c.serie].push(c);
  });

  for (const serie in groupBySerie) {
    const achatsConnus = groupBySerie[serie].map(c=>c.prixAchat).filter(v=>v!=null);
    const moyenneAchat = achatsConnus.length ? (achatsConnus.reduce((a,b)=>a+b,0)/achatsConnus.length) : 0;
    seriesMoyennes[serie] = moyenneAchat;
  }

  const seriesStats = {};

  allCards.forEach(c => {
    const achat = c.prixAchat ?? 0;
    const actuel = c.prixActuel ?? 0;

    if (achat) totalAchat += achat;
    if (actuel) totalActuel += actuel;

    const achatSim = c.prixAchat ?? seriesMoyennes[c.serie];
    const actuelSim = c.prixActuel ?? achatSim;

    totalAchatSim += achatSim;
    totalActuelSim += actuelSim;

    if (!seriesStats[c.serie]) {
      seriesStats[c.serie] = { achat:0, actuel:0, achatSim:0, actuelSim:0 };
    }
    seriesStats[c.serie].achat += achat;
    seriesStats[c.serie].actuel += actuel;
    seriesStats[c.serie].achatSim += achatSim;
    seriesStats[c.serie].actuelSim += actuelSim;
  });

  // Mise √† jour des totaux globaux
  document.querySelector("#statAchat span").textContent = totalAchat.toFixed(2) + " ‚Ç¨";
  document.querySelector("#statActuel span").textContent = totalActuel.toFixed(2) + " ‚Ç¨";
  document.querySelector("#statGain span").textContent = (totalActuel-totalAchat).toFixed(2) + " ‚Ç¨";

  document.querySelector("#statAchatSim span").textContent = totalAchatSim.toFixed(2) + " ‚Ç¨";
  document.querySelector("#statActuelSim span").textContent = totalActuelSim.toFixed(2) + " ‚Ç¨";
  document.querySelector("#statGainSim span").textContent = (totalActuelSim-totalAchatSim).toFixed(2) + " ‚Ç¨";

  // Remplir tableau par s√©rie
  const tbody = document.querySelector("#seriesTable tbody");
  tbody.innerHTML = "";
  Object.entries(seriesStats).forEach(([serie, vals]) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${serie}</td>
      <td>${vals.achat.toFixed(2)} ‚Ç¨</td>
      <td>${vals.actuel.toFixed(2)} ‚Ç¨</td>
      <td>${vals.achatSim.toFixed(2)} ‚Ç¨</td>
      <td>${vals.actuelSim.toFixed(2)} ‚Ç¨</td>
      <td>${(vals.actuel - vals.achat).toFixed(2)} ‚Ç¨</td>
      <td>${(vals.actuelSim - vals.achatSim).toFixed(2)} ‚Ç¨</td>
    `;
    tbody.appendChild(row);
  });
}
</script>
</body>
</html>
